<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Vistoria Técnica</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
*{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto;-webkit-tap-highlight-color:transparent}
html,body{margin:0;padding:0;background:#0f172a;color:#e5e7eb}
body{min-height:100vh}
header{background:#020617;color:#fff;padding:16px;text-align:center;font-weight:600;font-size:18px}
main{padding:14px;max-width:700px;margin:auto;width:100%}
.card{background:#fff;color:#222;border-radius:12px;padding:16px;margin-bottom:16px;box-shadow:0 6px 16px rgba(0,0,0,.25);width:100%;overflow:hidden}
h2{margin:0 0 12px;font-size:17px}
label{font-size:13px;font-weight:600;margin-top:10px;display:block}
input,select,textarea,button{width:100%;max-width:100%;padding:12px;margin-top:6px;border:1px solid #ccc;border-radius:8px;font-size:16px;background:#fff}
textarea{resize:vertical;min-height:70px}
button{background:#2563eb;color:#fff;border:none;font-weight:600;margin-top:12px;cursor:pointer}
button.secondary{background:#e5e7eb;color:#111}
button.danger{background:#dc2626}
.item{border-top:1px solid #eee;padding:12px 0;font-size:14px;display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;cursor:pointer}
.result{font-weight:700;margin-top:10px;font-size:14px}
footer{text-align:center;padding:16px;font-size:12px;color:#9ca3af}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:1000;padding:20px}
.modal-content{background:#fff;color:#222;border-radius:12px;padding:18px;width:100%;max-width:420px}
.modal-actions{display:flex;gap:10px;margin-top:18px}
.modal-actions button{flex:1}
</style>
</head>

<body>
<header>Vistoria Técnica</header>

<main>

<div class="card">
<h2>Dados da Vistoria</h2>
<label>Nome</label><input id="vistoriaNome">
<label>Data</label><input type="date" id="vistoriaData">
<label>Responsável</label><input id="vistoriaResp">
</div>

<div class="card">
<h2>Novo Item</h2>
<label>Descrição</label><textarea id="desc"></textarea>
<label>Unidade</label><select id="unidade"></select>
<div id="dimensoes"></div>
<div class="result" id="resultado"></div>
<label>Foto</label><input type="file" id="foto" accept="image/*" capture="environment">
<button type="button" onclick="addItem()">Adicionar Item</button>
</div>

<div class="card">
<h2>Itens da Vistoria</h2>
<div id="lista"></div>
<button type="button" class="secondary" onclick="salvarVistoria()">Salvar Vistoria</button>
</div>

<div class="card">
<h2>Vistorias Salvas</h2>
<div id="vistoriasLista"></div>
</div>

</main>

<footer>Elaborado por: Eng. Leonardo Cavalcante</footer>

<!-- MODAL -->
<div class="modal" id="modalVistoria">
  <div class="modal-content">
    <h3 id="modalTitulo"></h3>
    <div class="modal-actions">
      <button onclick="gerarRelatorioSelecionado()">Gerar Relatório</button>
      <button onclick="editarSelecionado()">Editar</button>
      <button class="danger" onclick="excluirSelecionado()">Excluir</button>
    </div>
    <button class="secondary" onclick="fecharModal()" style="margin-top:12px;">Fechar</button>
  </div>
</div>

<script>
const { jsPDF } = window.jspdf

let db
function iniciarDB(){
 return new Promise((resolve,reject)=>{
  const request=indexedDB.open("VistoriasDB",1)
  request.onupgradeneeded=e=>{
   db=e.target.result
   db.createObjectStore("vistorias",{keyPath:"id",autoIncrement:true})
  }
  request.onsuccess=e=>{db=e.target.result;resolve()}
 })
}
function salvarTodas(lista){
 return new Promise(resolve=>{
  const tx=db.transaction("vistorias","readwrite")
  const store=tx.objectStore("vistorias")
  store.clear()
  lista.forEach(v=>store.add(v))
  tx.oncomplete=()=>resolve()
 })
}
function carregarTodas(){
 return new Promise(resolve=>{
  const tx=db.transaction("vistorias","readonly")
  const store=tx.objectStore("vistorias")
  const req=store.getAll()
  req.onsuccess=()=>resolve(req.result||[])
 })
}

const unidades={
 m:{label:"Metro (m)",dims:["Comprimento"],calc:d=>d[0]},
 m2:{label:"Metro Quadrado (m²)",dims:["Largura","Altura"],calc:d=>d[0]*d[1]},
 m3:{label:"Metro Cúbico (m³)",dims:["Comprimento","Largura","Altura"],calc:d=>d[0]*d[1]*d[2]},
 un:{label:"Unidade",dims:["Quantidade"],calc:d=>d[0]}
}

let vistoriaAtual={itens:[]}
let vistorias=[]
let editIndex=null
let selecionadoIndex=null

Object.keys(unidades).forEach(u=>{
 unidade.innerHTML+=`<option value="${u}">${unidades[u].label}</option>`
})

function renderDims(){
 dimensoes.innerHTML=""
 unidades[unidade.value].dims.forEach(()=>dimensoes.innerHTML+=`<input type="number" step="any">`)
}
renderDims()
unidade.onchange=renderDims
dimensoes.oninput=calc

function calc(){
 const v=[...dimensoes.querySelectorAll("input")].map(i=>+i.value||0)
 resultado.innerText=v.some(x=>!x)?"":`${v.join(" x ")} = ${unidades[unidade.value].calc(v).toFixed(2)} ${unidade.value}`
}

function addItem(){
 if(!desc.value.trim())return
 const vals=[...dimensoes.querySelectorAll("input")].map(i=>+i.value||0)
 const file=foto.files[0]
 const r=new FileReader()
 r.onload=e=>{
  vistoriaAtual.itens.push({
   desc:desc.value,
   unidade:unidade.value,
   dims:vals,
   total:unidades[unidade.value].calc(vals),
   foto:e.target.result
  })
  desc.value="";foto.value="";resultado.innerText=""
  dimensoes.querySelectorAll("input").forEach(i=>i.value="")
  renderLista()
 }
 if(file) r.readAsDataURL(file)
}

function renderLista(){
 lista.innerHTML=""
 vistoriaAtual.itens.forEach((i,n)=>{
  lista.innerHTML+=`
  <div class="item">
   <div>
    <b>${n+1}. ${i.desc}</b><br>
    ${i.dims.join(" x ")} = ${i.total.toFixed(2)} ${i.unidade}
   </div>
  </div>`
 })
}

async function salvarVistoria(){
 if(!vistoriaNome.value.trim())return
 if(vistoriaAtual.itens.length===0)return

 const dados={
  nome:vistoriaNome.value,
  data:formatarDataBR(vistoriaData.value),
  resp:vistoriaResp.value,
  itens:vistoriaAtual.itens
 }

 if(editIndex!==null){
  vistorias[editIndex]=dados
  editIndex=null
 }else{
  vistorias.push(dados)
 }

 await salvarTodas(vistorias)

 vistoriaAtual={itens:[]}
 vistoriaNome.value=""
 vistoriaResp.value=""
 vistoriaData.value=dataHojeISO()
 renderLista()
 renderVistorias()
}

function renderVistorias(){
 vistoriasLista.innerHTML=""
 vistorias.forEach((v,i)=>{
  vistoriasLista.innerHTML+=`
   <div class="item" onclick="abrirModal(${i})">
     <div>
      <b>${v.nome}</b><br>${v.data} - ${v.resp}
     </div>
   </div>`
 })
}

/* ===== MODAL ===== */

function abrirModal(index){
 selecionadoIndex=index
 const v=vistorias[index]
 modalTitulo.innerText=v.nome+" ("+v.data+")"
 modalVistoria.style.display="flex"
}
function fecharModal(){
 modalVistoria.style.display="none"
}

function gerarRelatorioSelecionado(){
 gerarPDF(vistorias[selecionadoIndex])
 fecharModal()
}
function editarSelecionado(){
 editarVistoria(selecionadoIndex)
 fecharModal()
}
function excluirSelecionado(){
 if(!confirm("Deseja excluir esta vistoria?"))return
 vistorias.splice(selecionadoIndex,1)
 salvarTodas(vistorias)
 renderVistorias()
 fecharModal()
}

/* ===== PDF (inalterado) ===== */

function gerarPDF(v){
 const pdf=new jsPDF("p","mm","a4")
 let y=18
 const colWidth=90
 const gap=8

 pdf.setFontSize(16)
 pdf.text("RELATÓRIO FOTOGRÁFICO DE VISTORIA",105,y,{align:"center"})
 y+=10

 pdf.setFontSize(10)
 pdf.rect(10,y,190,20)
 pdf.text(`Vistoria: ${v.nome}`,12,y+6)
 pdf.text(`Data: ${v.data}`,12,y+12)
 pdf.text(`Responsável: ${v.resp}`,110,y+6)
 y+=28

 for(let i=0;i<v.itens.length;i+=2){
  if(y>220){pdf.addPage();y=20}
  const item1=v.itens[i]
  const item2=v.itens[i+1]

  ;[item1,item2].forEach((item,idx)=>{
   if(!item)return
   const x=10+(idx*(colWidth+gap))
   pdf.setFillColor(240,240,240)
   pdf.rect(x,y,colWidth,8,"F")
   pdf.setFontSize(10)
   pdf.text(`${i+idx+1}. ${item.desc}`,x+2,y+6)
   pdf.setFontSize(8)
   pdf.text(`Memória de cálculo: ${item.dims.join(" x ")} = ${item.total.toFixed(2)} ${item.unidade}`,
    x+2,y+14,{maxWidth:colWidth-4})
   if(item.foto){
    pdf.rect(x,y+18,colWidth,50)
    pdf.addImage(item.foto,"JPEG",x,y+18,colWidth,50)
   }
  })
  y+=72
 }

 pdf.save(`RELATORIO_${v.nome.replace(/\s+/g,"_")}.pdf`)
}

/* ===== Datas ===== */

function formatarDataBR(dataISO){
 const [a,m,d]=dataISO.split("-")
 return `${d}/${m}/${a}`
}
function reverterDataISO(dataBR){
 const [d,m,a]=dataBR.split("/")
 return `${a}-${m}-${d}`
}
function dataHojeISO(){
 return new Date().toISOString().split("T")[0]
}

function editarVistoria(index){
 const v=vistorias[index]
 editIndex=index
 vistoriaNome.value=v.nome
 vistoriaResp.value=v.resp
 vistoriaData.value=reverterDataISO(v.data)
 vistoriaAtual.itens=[...v.itens]
 renderLista()
}

(async function init(){
 await iniciarDB()
 vistorias=await carregarTodas()
 vistoriaData.value=dataHojeISO()
 renderVistorias()
})()
</script>
</body>
</html>
